---
layout: post
title: "Unbaked Pie TryHackMe"
subtitle: "# WriteUp"
date: 2020-12-19 23:45:13 +0100
background: '/img/posts/06.jpg'
---

<h1 class="code-line" data-line-start=8 data-line-end=9 ><a id="Unbaked_Pie_TryHackMe_WriteUp_8"></a>Unbaked Pie TryHackMe WriteUp</h1>
<p class="has-line-data" data-line-start="10" data-line-end="11"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-1.png" alt="TryHackMe - Unbacked Pie"></p>
<p class="has-line-data" data-line-start="12" data-line-end="13">Se nos presenta una maquina, donde encontraremos un <code>sitio web vulnerable</code> a la deserializacion insegura de <code>[pickle](https://davidhamann.de/2020/04/05/exploiting-python-pickle/)</code>, el proposito es explotar la vulnerabilidad y acceder a un contenedor docker como usuario root.  El nivel que se le ha dado a esta maquina es <strong>Medio</strong>, ya que debemos tener algunos conceptos para lograr acceder y encontrar la <strong><code>flag</code></strong>.</p>
<p class="has-line-data" data-line-start="14" data-line-end="16">Como siempre en estos casos, lo primero que debemos hacer es realizar un escaneo de puertos, para identificar donde encontramos los servicios.<br>
IMAGEN</p>
<p class="has-line-data" data-line-start="17" data-line-end="18">Vemos que hay un servicio web en el puerto <code>5300</code>, por esta razon vamos a la direrccion <code>IP:PORT</code> y vemos que esta alojado alli.</p>
<p class="has-line-data" data-line-start="19" data-line-end="21"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-2.png" alt="TryHackMe - Unbacked Pie"><br>
Hacemos una verificacion de cada enlace y formulario, vemos que “aparentemente” todo esta correcto, no hay forma de encontrar una vulnerabilidad, pero nos fijamos que los post hacen referencia a <code>Pickle</code>, una vulnerabilidad que tienen algunos sitios web realizados en python en una deseralizacion insegura de pickle, que permite la ejecucion remota de codigo.  Nos aprovecharemos de esto.</p>
<p class="has-line-data" data-line-start="22" data-line-end="23">Vamos a utilizar <code>BurpSuite</code> para interceptar las peticiones y respuesta del servidor, y analizaremos si hay algo que podamos aprovechar en la vulnerabilidad que posiblemente tiene.</p>
<p class="has-line-data" data-line-start="24" data-line-end="26"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-3.png" alt="TryHackMe - Unbaked Pie"><br>
Observamos que cuando se realiza una busqueda, el servidor nos responde con una nueva cookie calle <strong>search_cookie</strong> que al parecer es un objeto python serializado.</p>
<p class="has-line-data" data-line-start="27" data-line-end="28">Serializacion es usado para convertir un objeto python en un flujo de datos que se envia al backend del servidor donde se deserializa para obtener el objeto.  Pero si la entrada del usuario se deserializa sin sanitizar, podria causar muchos problemas.  Vamos a enviar un codigo para comprobar si el servidor sanitiza la entrada o la ejecuta tal como se la enviamos.</p>
<p class="has-line-data" data-line-start="29" data-line-end="31"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-4.png" alt="TryHackMe - Unbaked Pie"><br>
En el ejemplo anterior, lo que hemos hecho es cargar el modulo de <code>pickle</code>, asignamos un valor (el que obtenemos de la cookie anterior) a una variable <code>val</code>y lo decodificamos con el modulo <code>b64decode</code> de <code>base64</code>; posteriormente lo cargamos con el modulo pickle para ver como lo procesa pickle.  Esta prueba de concepto nos ayudara a entender cómo funciona y crearemos un script para que codifique el payload que queremos enviar al servidor (que tal una <strong><code>shell reversa</code></strong>?).  Si deseas mas informacion acerca de pickle, puedes ver esta informacion en este <a href="https://davidhamann.de/2020/04/05/exploiting-python-pickle/">blog</a>.</p>
<p class="has-line-data" data-line-start="32" data-line-end="33">Vemos que las entradas se ejecutan tal como las enviamos, no hay una sanitizacion correcta, es por esto que vamos a aprovecharnos para tratar de acceder y obtener una shell reversa. Asi que, vamos a crear un pequeño script, que nos codificara la cookie que deberiamos introducir para poder lograr el objetivo.</p>
<p class="has-line-data" data-line-start="34" data-line-end="36"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-5.png" alt="Script Pickle - Shell Reversa"><br>
Ejecutamos el script que hemos creado y obtenemos la cookie que debemos reemplazar.</p>
<p class="has-line-data" data-line-start="37" data-line-end="39"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-6.png" alt="TryHackMe - Unbaked Pie"><br>
Vamos a utilizar BurpSuite para enviar esta cookie modificada y que nos devuelva la shell, por esto en nuestra maquina abrimos un netcat para que escuche las peticiones y podamos obtener la shell remota.</p>
<p class="has-line-data" data-line-start="40" data-line-end="44"><img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-7.png" alt="TryHackMe - Unbaked Pie"><br>
Esto nos abre en nuestra maquina la shell.<br>
<img src="https://ch4m17ux.github.io/img/posts/unbaked-pie-THM-8.png" alt="TryHackMe - Unbacked Pie"><br>
Somos root, pero unicamente dentro del contenedor.</p>
